<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>FoodApp ‚Äî –î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      background: #f2f2f7;
      color: #1d1d1f;
      max-width: 500px;
      margin: 0 auto;
      min-height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }

    .header {
      background: #0088cc;
      color: white;
      padding: 16px 16px 12px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .cart-icon {
      position: absolute;
      top: 16px;
      right: 16px;
      background: white;
      color: #0088cc;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      cursor: pointer;
    }

    .content {
      padding: 16px;
    }

    .dish-card {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }

    .dish-card:active {
      transform: scale(0.98);
      background: #fafafa;
    }

    .dish-img {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
      margin-right: 16px;
    }

    .dish-info {
      flex: 1;
    }

    .dish-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .dish-desc {
      font-size: 13px;
      color: #6e6e73;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .dish-price {
      font-weight: 600;
      color: #0088cc;
      font-size: 16px;
    }

    .add-btn {
      background: #0088cc;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .add-btn:active {
      background: #006699;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: flex-end;
      justify-content: flex-end;
      flex-direction: column;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-height: 80vh;
      border-radius: 20px 20px 0 0;
      padding: 24px 20px 30px;
      animation: slideUp 0.3s ease-out;
      overflow-y: auto;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .close-modal {
      font-size: 24px;
      color: #8e8e93;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
    }

    .close-modal:active {
      background: #f2f2f7;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid #f2f2f7;
      align-items: center;
    }

    .cart-item-info {
      flex: 1;
    }

    .cart-item-name {
      font-weight: 600;
      font-size: 15px;
    }

    .cart-item-price {
      color: #0088cc;
      font-weight: 600;
    }

    .remove-btn {
      background: #ff3b30;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      margin-left: 10px;
      transition: background 0.2s;
    }

    .remove-btn:active {
      background: #e03025;
    }

    .cart-total {
      text-align: right;
      font-size: 18px;
      font-weight: 700;
      margin: 24px 0 16px;
      color: #0088cc;
    }

    .checkout-btn {
      background: #0088cc;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: background 0.2s;
    }

    .checkout-btn:active {
      background: #006699;
    }

    .checkout-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
      z-index: 90;
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      color: #8e8e93;
      cursor: pointer;
      padding: 4px 0;
    }

    .tab.active {
      color: #0088cc;
    }

    .tab-icon {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .empty-cart {
      text-align: center;
      color: #8e8e93;
      padding: 40px 20px;
      font-size: 15px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 14px;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
      outline: none;
    }

    .form-input:focus {
      border-color: #0088cc;
    }

    .submit-btn {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      margin-top: 10px;
    }

    .submit-btn:active {
      background: #229954;
    }

    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .loading {
      background: rgba(255,255,255,0.8);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 300;
      font-weight: 600;
      color: #0088cc;
    }

    ::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>
<body>

  <div class="header">
    FoodApp
    <div class="cart-icon" id="cart-icon">üõí<span id="cart-count">0</span></div>
  </div>

  <div class="content" id="menu-list"></div>

  <div class="footer">
    <div class="tab active">
      <div class="tab-icon">üè†</div>
      <div>–ú–µ–Ω—é</div>
    </div>
    <div class="tab">
      <div class="tab-icon">‚ù§Ô∏è</div>
      <div>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
    </div>
    <div class="tab">
      <div class="tab-icon">üì±</div>
      <div>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
  </div>

  <div class="modal" id="cart-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üõí –ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="close-modal" id="close-modal">√ó</div>
      </div>
      <div id="cart-items"></div>
      <div class="cart-total">–ò—Ç–æ–≥–æ: <span id="cart-total">0</span> ‚ÇΩ</div>
      <button class="checkout-btn" id="checkout-btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </div>

  <div class="modal" id="order-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üì¶ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
        <div class="close-modal" id="close-order-modal">√ó</div>
      </div>
      <form id="order-form">
        <div class="form-group">
          <label class="form-label">–í–∞—à–µ –∏–º—è *</label>
          <input type="text" class="form-input" id="user-name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
        </div>
        <div class="form-group">
          <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
          <input type="tel" class="form-input" id="user-phone" required placeholder="+7 (999) 123-45-67">
        </div>
        <div class="form-group">
          <label class="form-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
          <textarea class="form-input" id="user-address" required placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –ø–æ–¥—ä–µ–∑–¥, —ç—Ç–∞–∂, –∫–≤–∞—Ä—Ç–∏—Ä–∞" rows="3"></textarea>
        </div>
        <div class="form-group">
  <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –∑–∞–∫–∞–∑—É</label>
  <textarea class="form-input" id="user-note" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–∑ –ª—É–∫–∞, –∫ 19:00, –æ—Å—Ç–∞–≤–∏—Ç—å —É –¥–≤–µ—Ä–∏" rows="3"></textarea>
</div>
        <button type="submit" class="submit-btn" id="submit-order">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </form>
    </div>
  </div>

  <div class="loading" id="loading" style="display:none;">
    –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞...
  </div>

  <script>
    const dishes = [
      { id: 1, name: "–ë—É—Ä–≥–µ—Ä —Å —Å—ã—Ä–æ–º", desc: "–ì–æ–≤—è–¥–∏–Ω–∞, —Å—ã—Ä —á–µ–¥–¥–µ—Ä, –æ–≤–æ—â–∏", price: 299, img: "https://via.placeholder.com/150/ff6b6b/ffffff?text=–±—É—Ä–≥–µ—Ä" },
      { id: 2, name: "–ü–∏—Ü—Ü–∞ –ü–µ–ø–ø–µ—Ä–æ–Ω–∏", desc: "–¢–æ–Ω–∫–æ–µ —Ç–µ—Å—Ç–æ, –ø–µ–ø–ø–µ—Ä–æ–Ω–∏, –º–æ—Ü–∞—Ä–µ–ª–ª–∞", price: 499, img: "https://via.placeholder.com/150/4ecdc4/ffffff?text=–ø–∏—Ü—Ü–∞" },
      { id: 3, name: "–°—É—à–∏ –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è", desc: "–õ–æ—Å–æ—Å—å, —Å–ª–∏–≤–æ—á–Ω—ã–π —Å—ã—Ä, –∞–≤–æ–∫–∞–¥–æ", price: 699, img: "https://via.placeholder.com/150/45b7d1/ffffff?text=—Å—É—à–∏" },
      { id: 4, name: "–ö–∞—Ä—Ç–æ—à–∫–∞ –§—Ä–∏", desc: "–ó–æ–ª–æ—Ç–∏—Å—Ç–∞—è, —Ö—Ä—É—Å—Ç—è—â–∞—è", price: 129, img: "https://via.placeholder.com/150/f7b731/ffffff?text=—Ñ—Ä–∏" },
      { id: 5, name: "–ö–æ–ª–∞ 0.5–ª", desc: "–û—Å–≤–µ–∂–∞—é—â–∏–π –Ω–∞–ø–∏—Ç–æ–∫", price: 99, img: "https://via.placeholder.com/150/3498db/ffffff?text=–∫–æ–ª–∞" },
      { id: 6, name: "–ß–∏–∑–∫–µ–π–∫", desc: "–ù–µ–∂–Ω—ã–π –¥–µ—Å–µ—Ä—Ç —Å —è–≥–æ–¥–∞–º–∏", price: 249, img: "https://via.placeholder.com/150/9b59b6/ffffff?text=—á–∏–∑–∫–µ–π–∫" }
    ];

    let cart = [];

    // === –ó–ê–ì–†–£–ó–ö–ê –ò–ó –•–†–ê–ù–ò–õ–ò–©–ê ===
    function loadFromStorage() {
      const saved = localStorage.getItem('foodAppCart');
      if (saved) cart = JSON.parse(saved);
    }

    function saveCart() {
      localStorage.setItem('foodAppCart', JSON.stringify(cart));
    }

    function saveUser(name, phone, address) {
      localStorage.setItem('foodAppUser', JSON.stringify({ name, phone, address }));
    }

    function loadUser() {
      const saved = localStorage.getItem('foodAppUser');
      if (saved) {
        const user = JSON.parse(saved);
        document.getElementById('user-name').value = user.name || '';
        document.getElementById('user-phone').value = user.phone || '';
        document.getElementById('user-address').value = user.address || '';
      }
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    document.addEventListener('DOMContentLoaded', function() {
      loadFromStorage();
      loadUser();
      renderMenu();
      setupListeners();
      updateCartUI();

      // Telegram WebApp
      if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#0088cc');
        tg.setBackgroundColor('#f2f2f7');

        const user = tg.initDataUnsafe?.user;
        if (user) {
          let name = localStorage.getItem('foodAppUserName') || '';
          if (!name) {
            name = (user.first_name || '') + (user.last_name ? ' ' + user.last_name : '');
            localStorage.setItem('foodAppUserName', name);
          }
          document.getElementById('user-name').value = name;
          localStorage.setItem('tg_user_id', 413921406);
        }
      }
    });

    function renderMenu() {
      const list = document.getElementById('menu-list');
      list.innerHTML = dishes.map(d => `
        <div class="dish-card">
          <img class="dish-img" src="${d.img}" alt="${d.name}">
          <div class="dish-info">
            <div class="dish-name">${d.name}</div>
            <div class="dish-desc">${d.desc}</div>
            <div class="dish-price">${d.price} ‚ÇΩ</div>
            <button class="add-btn" data-id="${d.id}">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      `).join('');
    }

    function setupListeners() {
      document.addEventListener('click', e => {
        if (e.target.classList.contains('add-btn')) {
          addToCart(+e.target.dataset.id);
        }
      });

      document.getElementById('cart-icon').onclick = openCart;
      document.getElementById('close-modal').onclick = closeCart;
      document.getElementById('cart-modal').onclick = e => { if (e.target === e.currentTarget) closeCart(); };

      document.getElementById('checkout-btn').onclick = () => {
        if (cart.length === 0) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
        closeCart();
        openOrderForm();
      };

      document.getElementById('close-order-modal').onclick = closeOrderForm;
      document.getElementById('order-modal').onclick = e => { if (e.target === e.currentTarget) closeOrderForm(); };

      document.getElementById('order-form').onsubmit = submitOrder;
    }

    function addToCart(id) {
      const dish = dishes.find(d => d.id === id);
      if (!dish) return;
      cart.push(dish);
      updateCartUI();
      saveCart();
    }

    function updateCartUI() {
      document.getElementById('cart-count').textContent = cart.length;
    }

    function openCart() {
      const el = document.getElementById('cart-items');
      const totalEl = document.getElementById('cart-total');
      const btn = document.getElementById('checkout-btn');

      el.innerHTML = '';

      if (cart.length === 0) {
        el.innerHTML = '<div class="empty-cart">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üò¢<br>–î–æ–±–∞–≤—å—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤–∫—É—Å–Ω–æ–µ!</div>';
        totalEl.textContent = '0';
        btn.disabled = true;
      } else {
        let total = 0;
        cart.forEach((item, i) => {
          total += item.price;
          el.innerHTML += `
            <div class="cart-item">
              <div class="cart-item-info">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">${item.price} ‚ÇΩ</div>
              </div>
              <button class="remove-btn" data-index="${i}">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `;
        });
        totalEl.textContent = total;
        btn.disabled = false;

        document.querySelectorAll('.remove-btn').forEach(btn => {
          btn.onclick = e => {
            removeFromCart(+e.target.dataset.index);
          };
        });
      }

      document.getElementById('cart-modal').style.display = 'flex';
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartUI();
      saveCart();
      openCart();
    }

    function closeCart() {
      document.getElementById('cart-modal').style.display = 'none';
    }

    function openOrderForm() {
      document.getElementById('order-modal').style.display = 'flex';
    }

    function closeOrderForm() {
      document.getElementById('order-modal').style.display = 'none';
    }

    // === –û–¢–ü–†–ê–í–ö–ê –ó–ê–ö–ê–ó–ê ===
    async function submitOrder(e) {
  e.preventDefault();

  const name = document.getElementById('user-name').value.trim();
  const phone = document.getElementById('user-phone').value.trim();
  const address = document.getElementById('user-address').value.trim();
  const note = document.getElementById('user-note').value.trim(); // ‚Üê –£–ñ–ï –ï–°–¢–¨!

  if (!name || !phone || !address) {
    return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
  }

  saveUser(name, phone, address);

  const total = cart.reduce((s, i) => s + i.price, 0);
  const userId = 413921406;

  document.getElementById('loading').style.display = 'flex';

  try {
    const response = await fetch('http://–¢–í–û–ô_IP_–ê–î–†–ï–°:3000/api/order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        phone,
        address,
        note, // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û!
        items: cart,
        total,
        user_id: userId
      })
    });

    const result = await response.json();

    if (result.success) {
      alert('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞.');
    } else {
      alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
    }
  } catch (err) {
    alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑: ' + err.message + '\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∑–∞–∫–∞–∑ –≤—Ä—É—á–Ω—É—é:');
    const orderText = `–ò–º—è: ${name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n–ê–¥—Ä–µ—Å: ${address}\n–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${note}\n–°—É–º–º–∞: ${total} ‚ÇΩ\n–ë–ª—é–¥–∞: ${cart.map(i => i.name).join(', ')}`;
    if (navigator.clipboard) {
      navigator.clipboard.writeText(orderText).then(() => {
        alert('üìã –¢–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
      });
    } else {
      alert('üìã –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:\n\n' + orderText);
    }
  } finally {
    document.getElementById('loading').style.display = 'none';
    cart = [];
    updateCartUI();
    saveCart();
    closeOrderForm();
  }
}
  </script>

</body>
</html>
